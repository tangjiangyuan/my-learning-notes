## 一、服务保护和分布式事务

### 1、前情回顾

![image-20250910214909552](./assets/image-20250910214909552.png)

## 二、雪崩问题

### 1、分析

![image-20250910215545095](./assets/image-20250910215545095.png)

![image-20250910215635408](./assets/image-20250910215635408.png)

### 2、小结

![image-20250910215931657](./assets/image-20250910215931657.png)

### 3、解决方案

#### 3.1、方案一-请求限流

![image-20250910220203168](./assets/image-20250910220203168.png)

#### 3.2、方案二-线程隔离

![image-20250910220821216](./assets/image-20250910220821216.png)

#### 3.3、方案三-服务熔断

![image-20250910221308590](./assets/image-20250910221308590.png)

#### 3.4、小结

![image-20250910221449829](./assets/image-20250910221449829.png)

#### 3.5、服务保护技术

![image-20250910221757189](./assets/image-20250910221757189.png)



### 4、Sentinel

#### 4.1、初始Sentinel

##### 4.1.1、介绍

![image-20250911100204940](./assets/image-20250911100204940.png)

##### 4.1.2、步骤

（1）下载jar包

（2）配置语句并执行

===因为Sentinel默认端口占用8080，与Tomacat服务器冲突了，需要改变端口

```Shell
java -Dserver.port=8090 -Dcsp.sentinel.dashboard.server=localhost:8090 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard.jar
```

![image-20250911111805589](./assets/image-20250911111805589.png)

![image-20250911111820048](./assets/image-20250911111820048.png)

===账号和密码都是sentinel

（3）引入依赖

```XML
<!--sentinel-->
<dependency>
    <groupId>com.alibaba.cloud</groupId> 
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

（4）配置文件

application.

```YAML
spring:
  cloud: 
    sentinel:
      transport:
        dashboard: localhost:8090
```

##### 4.1.3、演示

![image-20250911135515457](./assets/image-20250911135515457.png)



##### 4.1.4、簇点链路

![image-20250911135912453](./assets/image-20250911135912453.png)

##### 4.1.5、问题

​		问题：由于我们使用的是RESTful风格，因此像添加、更新的请求路径名称和簇点名称一致，导致无法具体监听

![image-20250911140216848](./assets/image-20250911140216848.png)

===解决：

![image-20250911140335537](./assets/image-20250911140335537.png)

![image-20250911140642074](./assets/image-20250911140642074.png)



#### 4.2、请求限流

##### 4.2.1、分析

![image-20250911141136953](./assets/image-20250911141136953.png)

##### 4.2.2、演示

![image-20250911142840167](./assets/image-20250911142840167.png)

![image-20250911142908663](./assets/image-20250911142908663.png)

![image-20250911142933049](./assets/image-20250911142933049.png)

![image-20250911143106842](./assets/image-20250911143106842.png)

符合预期结果



#### 4.3、线程隔离

##### 4.3.1、介绍

![image-20250911143530407](./assets/image-20250911143530407.png)

##### 4.3.2、分析

![image-20250911143741472](./assets/image-20250911143741472.png)

##### 4.3.3、演示

![image-20250911144247931](./assets/image-20250911144247931.png)

![image-20250911144619885](./assets/image-20250911144619885.png)

![image-20250911145318075](./assets/image-20250911145318075.png)

===没有开启线程隔离：此时已耗尽tomcat服务器的所有资源，导致无法再访问其它接口。

![image-20250911145417426](./assets/image-20250911145417426.png)

===开启线程隔离

![image-20250911145635123](./assets/image-20250911145635123.png)

此时就不会耗尽tomcat服务器的资源，可以正常访问其他接口，如删减数量。

![image-20250911145902413](./assets/image-20250911145902413.png)



#### 4.4、Fallback

##### 4.4.1、分析

![image-20250911150413796](./assets/image-20250911150413796.png)

##### 4.4.2、案例

![image-20250911150449030](./assets/image-20250911150449030.png)



##### 4.4.3、步骤

![image-20250911150806936](./assets/image-20250911150806936.png)

![image-20250911150906640](./assets/image-20250911150906640.png)



##### 4.4.4、演示

![image-20250911151800771](./assets/image-20250911151800771.png)

![image-20250911151915740](./assets/image-20250911151915740.png)

![image-20250911152055151](./assets/image-20250911152055151.png)

![image-20250911152512005](./assets/image-20250911152512005.png)

![image-20250911152806316](./assets/image-20250911152806316.png)

![image-20250911152925606](./assets/image-20250911152925606.png)

##### 4.4.5、总结

```
fallback的好处：即使服务查询失败，不会抛出异常，而是给出友好提示。
```



#### 4.5、服务熔断

##### 4.5.1、介绍

![image-20250911161110144](./assets/image-20250911161110144.png)

##### 4.5.2、原理

![image-20250911162216917](./assets/image-20250911162216917.png)

##### 4.5.3、分析

![image-20250911163055462](./assets/image-20250911163055462.png)

##### 4.5.4、演示

![image-20250911163416326](./assets/image-20250911163416326.png)



### 5、分布式事务

#### 5.1、介绍

![image-20250911165731726](./assets/image-20250911165731726.png)

#### 5.2、概念

​		在分布式系统中，如果一个业务需要多个服务合作完成，而且每个服务都有事务，多个事务必须同时成功或失败，这样的事务就是**分布式事务**。其中的每个服务的事务就是一个**分支事务**。整个业务称为**全局事务**。



#### 5.3、初始Seata

##### 5.3.1、介绍

![image-20250911170427206](./assets/image-20250911170427206.png)

##### 5.3.2、分布式事务解决思路

![image-20250911171020572](./assets/image-20250911171020572.png)

##### 5.3.3、Seata架构

![image-20250911172016087](./assets/image-20250911172016087.png)



#### 5.4、部署TC服务

##### 5.4.1、准备数据库表

Seata支持多种存储模式，但考虑到持久化的需要，我们一般选择基于数据库存储。执行课前资料提供的`《seata-tc.sql》`，导入数据库表

![image-20250911172740199](./assets/image-20250911172740199.png)

##### 5.4.2、准备配置文件

![image-20250911185241522](./assets/image-20250911185241522.png)

##### 5.4.3、Docker部署

![image-20250911185342770](./assets/image-20250911185342770.png)

```shell
docker load -i seata-1.5.1.tar # 加载镜像

docker network ls # 查看所有网络
docker inspect mysql # 查看mysql是否在hm-net网络里
docker inspect nacos # 查看nacos是否在hm-net网络里
docker network connect hm-net nacos # 如果nacos不在hm-net网络里，则加入该网络
```

然后在创建并运行容器seata

```Shell
docker run --name seata \
-p 8099:8099 \ # 微服务连接时使用的端口
-p 7099:7099 \ # 外部控制台访问的端口
-e SEATA_IP=192.168.100.128 \
-v ./seata:/seata-server/resources \
--privileged=true \
--network hm-net \
-d \
seataio/seata-server:1.5.2
```

![image-20250911190547147](./assets/image-20250911190547147.png)

```
192.168.100.128:7099
username: admin
password: admin
```

![image-20250911190659164](./assets/image-20250911190659164.png)



#### 5.5、微服务集成Seata

##### 5.5.1、步骤

在cart、item、trade服务中引入

```XML
<!--统一配置管理-->
  <dependency>
      <groupId>com.alibaba.cloud</groupId>
      <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
  </dependency>
  <!--读取bootstrap文件-->
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-bootstrap</artifactId>
  </dependency>
  <!--seata-->
  <dependency>
      <groupId>com.alibaba.cloud</groupId>
      <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
  </dependency>
```

![image-20250911190913879](./assets/image-20250911190913879.png)

![image-20250911192648010](./assets/image-20250911192648010.png)

（2）配置

![image-20250911191704584](./assets/image-20250911191704584.png)

![image-20250911191726681](./assets/image-20250911191726681.png)

```YAML
seata:
  registry: # TC服务注册中心的配置，微服务根据这些信息去注册中心获取tc服务地址
    type: nacos # 注册中心类型 nacos
    nacos:
      server-addr: 192.168.100.128:8848 # nacos地址
      namespace: "" # namespace，默认为空
      group: DEFAULT_GROUP # 分组，默认是DEFAULT_GROUP
      application: seata-server # seata服务名称
      username: nacos
      password: nacos
  tx-service-group: hmall # 事务组名称
  service:
    vgroup-mapping: # 事务组与tc集群的映射关系
      hmall: "default"
```

![image-20250911192123992](./assets/image-20250911192123992.png)

#### 5.6、XZ模式

##### 5.6.1、原理

![image-20250911200121412](./assets/image-20250911200121412.png)

```
耗时、性能差。不推荐
```

##### 5.6.2、小结

![image-20250911200319953](./assets/image-20250911200319953.png)

##### 5.6.3、实现步骤

![image-20250911200356963](./assets/image-20250911200356963.png)

（1）修改nacos的配置

```YAML
seata:
  data-source-proxy-mode: XA
```

![image-20250911200524228](./assets/image-20250911200524228.png)

（2）

![image-20250911200713977](./assets/image-20250911200713977.png)

![image-20250911200751940](./assets/image-20250911200751940.png)

![image-20250911200823732](./assets/image-20250911200823732.png)

##### 5.6.4、演示

即选择商品进入购物车，点击结算生成订单，此时再去修改数据库中选择商品的库存为0

![image-20250911200953686](./assets/image-20250911200953686.png)

![image-20250911201058471](./assets/image-20250911201058471.png)

点击结算后，进行了回滚

![image-20250911201231689](./assets/image-20250911201231689.png)



#### 5.7、AT模式

##### 5.7.1、介绍

![image-20250911203906051](./assets/image-20250911203906051.png)

##### 5.7.2、小结

![image-20250911204227757](./assets/image-20250911204227757.png)

##### 5.7.3、实现步骤

![image-20250911204515124](./assets/image-20250911204515124.png)

##### 5.7.4、演示

创建undo_log数据库表

![image-20250911204808199](./assets/image-20250911204808199.png)

![image-20250911204936531](./assets/image-20250911204936531.png)