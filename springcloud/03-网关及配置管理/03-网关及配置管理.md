## 一、网关

### 1、问题解析

===原本前端只需根据一个端口号，就可以访问所有的页面，但是现在将所有的服务进行了拆分，每个服务都有一个端口，那么前端如何确定具体访问哪个端口呢？

![image-20250909165823336](./assets/image-20250909165823336.png)

### 2、介绍

![image-20250909170433302](./assets/image-20250909170433302.png)

![image-20250909170731187](./assets/image-20250909170731187.png)

![image-20250909170749000](./assets/image-20250909170749000.png)

### 3、网关种类

![image-20250909170922620](./assets/image-20250909170922620.png)



### 4、网关路由

#### 4.1、快速入门 

##### 4.1.1、分析

![image-20250909171632008](./assets/image-20250909171632008.png)

##### 4.1.2、步骤

![image-20250909171847372](./assets/image-20250909171847372.png)

（1）创建模块

![image-20250909171936680](./assets/image-20250909171936680.png)

（2）引入依赖

```xml
<!--common-->
<dependency>
    <groupId>com.heima</groupId>
    <artifactId>hm-common</artifactId>
    <version>1.0.0</version>
</dependency>
<!--网关-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
<!--nacos discovery-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
<!--负载均衡-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

（3）启动类

![image-20250909183521301](./assets/image-20250909183521301.png)

（4）配置文件

![image-20250909191255936](./assets/image-20250909191255936.png)

#### 4.2、路由属性

##### 4.2.1、属性

![image-20250909191505444](./assets/image-20250909191505444.png)

##### 4.2.2、路由断言

![image-20250909191700408](./assets/image-20250909191700408.png)

##### 4.2.3、路由过滤器

![image-20250909192137531](./assets/image-20250909192137531.png)

===演示

![image-20250909193022929](./assets/image-20250909193022929.png)

![image-20250909193236802](./assets/image-20250909193236802.png)

![image-20250909193249375](./assets/image-20250909193249375.png)

===问题：如果每个服务都配过滤器，有没有简便的方法？

![image-20250909193535375](./assets/image-20250909193535375.png)



### 5、网关登录校验功能

##### 5.1、登录校验思路分析

（1）问题一

![image-20250909194014831](./assets/image-20250909194014831.png)

![image-20250909194412379](./assets/image-20250909194412379.png)

（2）问题二

![image-20250909194642471](./assets/image-20250909194642471.png)

（3）问题三

​		有一些复杂的业务还会出现微服务之间相互调用的情况，如：交易完成后清空购物车，那么trade-service就会调用cart-service，那么微服务之间如何转递用户信息？

![image-20250909195152708](./assets/image-20250909195152708.png)



#### 5.2、自定义过滤器

##### 5.2.1、种类

![image-20250909200705212](./assets/image-20250909200705212.png)

![image-20250909201037653](./assets/image-20250909201037653.png)

##### 5.2.2、演示

![image-20250909201712319](./assets/image-20250909201712319.png)

===扩展

![image-20250909201649232](./assets/image-20250909201649232.png)

![image-20250909201847635](./assets/image-20250909201847635.png)

![image-20250909202538199](./assets/image-20250909202538199.png)

===只要自定义的过滤器优先级高于NettyRoutingFilter过滤器的优先级即可

![image-20250909202512727](./assets/image-20250909202512727.png)



#### 5.3、实现登录校验

##### 5.3.1、案例

![image-20250909205601163](./assets/image-20250909205601163.png)



##### 5.3.2、演示

![image-20250909213400498](./assets/image-20250909213400498.png)

![image-20250909213543514](./assets/image-20250909213543514.png)

![image-20250909213638012](./assets/image-20250909213638012.png)

![image-20250909212755338](./assets/image-20250909212755338.png)

===补充：AntPathMatcher专门用于匹配带通配符和'/**'之类的路径



#### 5.4、网关转递用户

##### 5.4.1、思路

![image-20250909213936466](./assets/image-20250909213936466.png)

##### 5.4.2、步骤一

![image-20250909214044162](./assets/image-20250909214044162.png)

![image-20250909214608682](./assets/image-20250909214608682.png)

![image-20250909214715657](./assets/image-20250909214715657.png)

##### 5.4.3、步骤二

![image-20250909214841589](./assets/image-20250909214841589.png)

##### 5.4.4、演示

![image-20250909215725689](./assets/image-20250909215725689.png)

![image-20250909215844759](./assets/image-20250909215844759.png)

![image-20250909220242815](./assets/image-20250909220242815.png)

===配置拦截器

![image-20250909220421258](./assets/image-20250909220421258.png)

===配置类要想生效，需要被Spring扫描到，此时无法被扫描到

===Spring自动装配

![image-20250909220856101](./assets/image-20250909220856101.png)

![image-20250909220948469](./assets/image-20250909220948469.png)

```
===原因：网关模块hm-gateway的依赖也引入了hm-common，所以网关中也有拦截器的配置类。而WebMvcConfiguration是SpringMVC下的，网关的底层并不是基于SpringMVC，是一种响应式的、非阻塞式的编程，基于的是WebFlux。
```

![image-20250909221834830](./assets/image-20250909221834830.png)



#### 5.5、OpenFeign传递用户

##### 5.5.1、分析

![image-20250910151328246](./assets/image-20250910151328246.png)

##### 5.5.2、思路

![image-20250910151847858](./assets/image-20250910151847858.png)

##### 5.5.3、演示

![image-20250910160153097](./assets/image-20250910160153097.png)

![image-20250910160317833](./assets/image-20250910160317833.png)

##### 5.5.4、总结

![image-20250910154743128](./assets/image-20250910154743128.png)



### 6、配置管理

#### 6.1、介绍

![image-20250910182310058](./assets/image-20250910182310058.png)



#### 6.2、配置共享

##### 6.2.1、步骤一

![image-20250910182805373](./assets/image-20250910182805373.png)

![image-20250910182827301](./assets/image-20250910182827301.png)

##### 6.2.2、演示

```
localhost:8848/nacos
```

![image-20250910184518701](./assets/image-20250910184518701.png)



##### 6.2.3、步骤二

![image-20250910185622049](./assets/image-20250910185622049.png)

![image-20250910190157806](./assets/image-20250910190157806.png)

![image-20250910190450149](./assets/image-20250910190450149.png)

![image-20250910190613083](./assets/image-20250910190613083.png)

![image-20250910190724929](./assets/image-20250910190724929.png)

##### 6.2.4、演示

```XML
  <!--nacos配置管理-->
  <dependency>
      <groupId>com.alibaba.cloud</groupId>
      <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
  </dependency>
  <!--读取bootstrap文件-->
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-bootstrap</artifactId>
  </dependency>
```

![image-20250910192526110](./assets/image-20250910192526110.png)

![image-20250910192539585](./assets/image-20250910192539585.png)



#### 6.3、配置热更新

##### 6.3.1、介绍

![image-20250910193603663](./assets/image-20250910193603663.png)

##### 6.3.2、案例

![image-20250910193817407](./assets/image-20250910193817407.png)

![image-20250910194336492](./assets/image-20250910194336492.png)

![image-20250910194515986](./assets/image-20250910194515986.png)

![image-20250910194801650](./assets/image-20250910194801650.png)

![image-20250910195041237](./assets/image-20250910195041237.png)

![image-20250910195130167](./assets/image-20250910195130167.png)

===此时购物车的数量超过2

![image-20250910195209969](./assets/image-20250910195209969.png)

![image-20250910195231547](./assets/image-20250910195231547.png)



#### 6.4、动态路由

##### 6.4.1、分析

![image-20250910195615767](./assets/image-20250910195615767.png)

##### 6.4.2、步骤一

![image-20250910201244438](./assets/image-20250910201244438.png)

```
===getConfigAndSignListener: 先拉取配置文件并加载一次，然后再添加监听器；
为什么要先加载配置文件？
	如果不先加载一次配置文件，那么监听器监听的路由表中没有数据，那么监听器就白配置了。
```

##### 6.4.3、演示

===网关模块中添加相应的依赖

![image-20250910201738749](./assets/image-20250910201738749.png)

![image-20250910202030068](./assets/image-20250910202030068.png)

![image-20250910204817255](./assets/image-20250910204817255.png)

##### 6.4.4、步骤二-更新路由表

![image-20250910205339538](./assets/image-20250910205339538.png)

![image-20250910205757281](./assets/image-20250910205757281.png)

![image-20250910210721414](./assets/image-20250910210721414.png)

##### 6.4.5、演示

![image-20250910211240265](./assets/image-20250910211240265.png)

![image-20250910211133290](./assets/image-20250910211133290.png)

![image-20250910211458971](./assets/image-20250910211458971.png)

===更新路由表之前需要删除旧的路由表

![image-20250910212807215](./assets/image-20250910212807215.png)

![image-20250910213016620](./assets/image-20250910213016620.png)

==================

![image-20250910213500728](./assets/image-20250910213500728.png)

```JSON
[
    {
        "id": "item",
        "predicates": [{
            "name": "Path",
            "args": {"_genkey_0":"/items/**", "_genkey_1":"/search/**"}
        }],
        "filters": [],
        "uri": "lb://item-service"
    },
    {
        "id": "cart",
        "predicates": [{
            "name": "Path",
            "args": {"_genkey_0":"/carts/**"}
        }],
        "filters": [],
        "uri": "lb://cart-service"
    },
    {
        "id": "user",
        "predicates": [{
            "name": "Path",
            "args": {"_genkey_0":"/users/**", "_genkey_1":"/addresses/**"}
        }],
        "filters": [],
        "uri": "lb://user-service"
    },
    {
        "id": "trade",
        "predicates": [{
            "name": "Path",
            "args": {"_genkey_0":"/orders/**"}
        }],
        "filters": [],
        "uri": "lb://trade-service"
    },
    {
        "id": "pay",
        "predicates": [{
            "name": "Path",
            "args": {"_genkey_0":"/pay-orders/**"}
        }],
        "filters": [],
        "uri": "lb://pay-service"
    }
]
```

![image-20250910213839999](./assets/image-20250910213839999.png)

===发布之后

![image-20250910213855619](./assets/image-20250910213855619.png)