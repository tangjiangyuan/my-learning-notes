### RabbitMQ-高性能的异步通信组件

### 1、同步和异步的区别

![image-20250911205707545](./assets/image-20250911205707545.png)

![image-20250911210052794](./assets/image-20250911210052794.png)

![image-20250911210326224](./assets/image-20250911210326224.png)



### 2、初始MQ

#### 2.1、同步调用

##### 2.1.1、分析

![image-20250912093444286](./assets/image-20250912093444286.png)

##### 2.1.2、小结

![image-20250912093620891](./assets/image-20250912093620891.png)



#### 2.2、异步调用

##### 2.2.1、介绍

![image-20250912094052910](./assets/image-20250912094052910.png)

##### 2.2.2、分析

![image-20250912094931344](./assets/image-20250912094931344.png)

##### 2.2.3、小结

![image-20250912095203821](./assets/image-20250912095203821.png)

#### 2.3、MQ技术选型

![image-20250912102801092](./assets/image-20250912102801092.png)



### 3、RabbitMQ

#### 3.1、安装部署

##### 3.1.1、步骤

```shell
# 加载tar包
docekr load -i mq.tar
```

```Shell
docker run \
 -e RABBITMQ_DEFAULT_USER=mq \
 -e RABBITMQ_DEFAULT_PASS=123 \
 -v mq-plugins:/plugins \
 --name mq \
 --hostname mq \
 -p 15672:15672 \
 -p 5672:5672 \
 --network hm-net\
 -d \
 rabbitmq:3.8-management
```

![image-20250912113613679](./assets/image-20250912113613679.png)

![image-20250912113724555](./assets/image-20250912113724555.png)

##### 3.1.2、RabbitMQ基本介绍

![image-20250912141536077](./assets/image-20250912141536077.png)

#### 3.2、快速入门

##### 3.2.1、案例

![image-20250912141710719](./assets/image-20250912141710719.png)

##### 3.2.2、步骤

![image-20250912142018193](./assets/image-20250912142018193.png)

![image-20250912142134901](./assets/image-20250912142134901.png)

![image-20250912142630988](./assets/image-20250912142630988.png)

===为什么消息没有发送成功呢？

===交换机和队列没有建立联系。

![image-20250912143008777](./assets/image-20250912143008777.png)

![image-20250912143122854](./assets/image-20250912143122854.png)

![image-20250912143220899](./assets/image-20250912143220899.png)

![image-20250912143252998](./assets/image-20250912143252998.png)

##### 3.2.3、小结

![image-20250912143548512](./assets/image-20250912143548512.png)



#### 3.3、数据隔离

##### 3.3.1、案例

![image-20250912143923620](./assets/image-20250912143923620.png)

##### 3.3.2、演示

![image-20250912144121872](./assets/image-20250912144121872.png)

![image-20250912144326629](./assets/image-20250912144326629.png)

===登录新用户去调取mq用户的消息

![image-20250912144625142](./assets/image-20250912144625142.png)

![image-20250912144849535](./assets/image-20250912144849535.png)

![image-20250912144927512](./assets/image-20250912144927512.png)



### 4、Java客户端

#### 4.1、快速入门

##### 4.1.1介绍

![image-20250912145457918](./assets/image-20250912145457918.png)

##### 4.1.2、案例

![image-20250912150218800](./assets/image-20250912150218800.png)

##### 4.1.3、步骤

![image-20250912150342583](./assets/image-20250912150342583.png)

![image-20250912150436390](./assets/image-20250912150436390.png)

![image-20250912150455796](./assets/image-20250912150455796.png)

![image-20250912150719418](./assets/image-20250912150719418.png)

![image-20250912152314705](./assets/image-20250912152314705.png)

##### 4.1.4、演示

===配置文件

```YAML
spring:
  rabbitmq:
    host: 192.168.100.128 # 你的虚拟机IP
    port: 5672 # 端口
    virtual-host: /hmall # 虚拟主机
    username: hmall # 用户名
    password: 123 # 密码
```

![image-20250912151504540](./assets/image-20250912151504540.png)

![image-20250912152051991](./assets/image-20250912152051991.png)

![image-20250912152105730](./assets/image-20250912152105730.png)

![image-20250912153027787](./assets/image-20250912153027787.png)

![image-20250912153122610](./assets/image-20250912153122610.png)

##### 4.1.5、小结

![image-20250912160329488](./assets/image-20250912160329488.png)



#### 4.2、WorkQueues

##### 4.2.1、介绍

![image-20250912160814981](./assets/image-20250912160814981.png)

##### 4.2.2、案例

![image-20250912161000350](./assets/image-20250912161000350.png)

##### 4.2.3、演示

![image-20250912162000089](./assets/image-20250912162000089.png)

![image-20250912162015939](./assets/image-20250912162015939.png)

![image-20250912162205573](./assets/image-20250912162205573.png)

```
===workqueue的优点
队列中的消息只会被消费者使用一次；
一个队列绑定了两个消费者，采用了类似轮询的机制；
当发送的消息过多时，就可以使用workqueues任务模型来增加消费者，减轻压力，提升性能；
```

##### 4.2.4、新增需求

![image-20250912162846219](./assets/image-20250912162846219.png)

![image-20250912163719427](./assets/image-20250912163719427.png)

##### 4.2.5、消费者消息推送限制

![image-20250912163936919](./assets/image-20250912163936919.png)

![image-20250912164134463](./assets/image-20250912164134463.png)

##### 4.2.6、小结

![image-20250912164357613](./assets/image-20250912164357613.png)



#### 4.3、Fanout交换机

##### 4.3.1、介绍

![image-20250912164757181](./assets/image-20250912164757181.png)

特点：Fanout Exchange 会将接收到的消息路由到每一个跟其绑定的queue，所以也叫**广播模式**

##### 4.3.2、案例

![image-20250912165154008](./assets/image-20250912165154008.png)

![image-20250912165337318](./assets/image-20250912165337318.png)

![image-20250912165409083](./assets/image-20250912165409083.png)

交换机和队列进行绑定

![image-20250912165515259](./assets/image-20250912165515259.png)

##### 4.3.3、演示

![image-20250912170215401](./assets/image-20250912170215401.png)

![image-20250912170113586](./assets/image-20250912170113586.png)

![image-20250912170618056](./assets/image-20250912170618056.png)

##### 4.3.4、小结

![image-20250912170722318](./assets/image-20250912170722318.png)



#### 4.4、Direct交换机

##### 4.4.1、介绍

![image-20250912172056302](./assets/image-20250912172056302.png)

##### 4.4.2、案例

![image-20250912172203960](./assets/image-20250912172203960.png)

##### 4.4.3、演示

交换机和队列进行绑定

![image-20250912172602322](./assets/image-20250912172602322.png)

![image-20250912182834114](./assets/image-20250912182834114.png)

##### 4.4.4、小结

![image-20250912182942237](./assets/image-20250912182942237.png)



#### 4.5、Topic交换机

##### 4.5.1、介绍

![image-20250912183602607](./assets/image-20250912183602607.png)

##### 4.5.2、案例

![image-20250912183714230](./assets/image-20250912183714230.png)

##### 4.5.3、演示

![image-20250912184010510](./assets/image-20250912184010510.png)

![image-20250912184723275](./assets/image-20250912184723275.png)

![image-20250912184840134](./assets/image-20250912184840134.png)

##### 4.5.4、小结

![image-20250912185005527](./assets/image-20250912185005527.png)



#### 4.6、声明队列交换机

```
	上文提到的声明队列交换机的方式，在大型项目时不适用，手敲容易出错，因此，使用Java代码来声明队列和交换机。
```

##### 4.6.1、介绍

![image-20250912185522007](./assets/image-20250912185522007.png)

##### 4.6.2、基于Bean声明

```
队列和交换机可以通过new或xxxBuilder的方式声明；
而队列和交换机的绑定只能通过xxxBuilder的方式声明。
```

![image-20250912185719608](./assets/image-20250912185719608.png)

![image-20250912185819871](./assets/image-20250912185819871.png)

##### 4.6.3、演示

![image-20250912202536074](./assets/image-20250912202536074.png)

##### 4.6.4、基于注解声明

```
对于Direct交换机来说，基于Bean的声明太过繁琐，每有一个BindingKey就需要写一个方法。
```

![image-20250912204121777](./assets/image-20250912204121777.png)

##### 4.6.5、演示

![image-20250912205052690](./assets/image-20250912205052690.png)



#### 4.7、消息转换器

##### 4.7.1、案例

![image-20250913110721150](./assets/image-20250913110721150.png)

##### 4.7.2、演示

![image-20250913111220113](./assets/image-20250913111220113.png)

![image-20250913111243508](./assets/image-20250913111243508.png)

![image-20250913114500922](./assets/image-20250913114500922.png)

```
因此，不推荐使用JDK自带的转换器。
```



##### 4.7.3、推荐转换器

![image-20250913114655433](./assets/image-20250913114655433.png)

##### 4.7.4、演示

```xml
<!--jackson-->
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
</dependency>
```

![image-20250913115338566](./assets/image-20250913115338566.png)

启动测试类

![image-20250913115509693](./assets/image-20250913115509693.png)

![image-20250913120705325](./assets/image-20250913120705325.png)



#### 4.8、业务改造

![image-20250913125645954](./assets/image-20250913125645954.png)

trade、和pay服务都需要引入amqp的依赖

```xml
<!--amqp-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

添加配置信息

```yaml
spring:
  rabbitmq:
    host: 192.168.100.128 # 你的虚拟机IP
    port: 5672 # 端口
    virtual-host: /hmall # 虚拟主机
    username: hmall # 用户名
    password: 123 # 密码
```

消息的发送者和接收者都需要消息转换器，所以在common中编写配置类

![image-20250913130700887](./assets/image-20250913130700887.png)

![image-20250913130817934](./assets/image-20250913130817934.png)

![image-20250913131923673](./assets/image-20250913131923673.png)

![image-20250913132852640](./assets/image-20250913132852640.png)